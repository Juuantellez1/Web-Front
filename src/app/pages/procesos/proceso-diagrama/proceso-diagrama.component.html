<div class="container">
  @if (loading()) {
    <div class="loading">
      <div class="spinner"></div>
      <p>Cargando editor...</p>
    </div>
  } @else if (error()) {
    <div class="error">
      <p>{{ error() }}</p>
      <a routerLink="/procesos" class="btn btn-primary">Volver a Procesos</a>
    </div>
  } @else if (proceso()) {
    <div class="header">
      <div class="header-info">
        <h1>Editor: {{ proceso()!.nombre }}</h1>
        <p class="subtitle">Arrastra elementos y conéctalos</p>
      </div>
      <div class="header-actions">
        <a [routerLink]="['/procesos', procesoId]" class="btn btn-secondary">
          ← Ver Detalle
        </a>
        <a routerLink="/procesos" class="btn btn-secondary">
          Salir
        </a>
      </div>
    </div>

    <div class="content-layout">
      <div class="sidebar">
        <h3>Herramientas</h3>
        <button class="tool-btn" (click)="nuevaActividad()">
          ⬜ Nueva Actividad
        </button>
        <button class="tool-btn" (click)="nuevoGateway()">
          ◇ Nuevo Gateway
        </button>

        <div class="info-panel">
          <small>Arrastra los nodos para moverlos.</small>
          <small>Usa el botón verde (+) para conectar.</small>
        </div>
      </div>

      <div class="canvas-container"
           (mousemove)="moverArcoTemporal($event)"
           (mouseup)="cancelarArco()">

        <svg class="connections-layer">
          <defs>
            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto">
              <polygon points="0 0, 10 3.5, 0 7" fill="#667eea"/>
            </marker>
          </defs>

          @for (arco of arcos(); track arco.id) {
            <path [attr.d]="obtenerRutaArco(arco)"
                  stroke="#667eea" stroke-width="2" fill="none" marker-end="url(#arrowhead)"
                  (click)="editarArco(arco)"
                  style="cursor: pointer; pointer-events: stroke;"/>
          }

          @if (dibujandoArco() && nodoOrigen) {
            <line [attr.x1]="(nodoOrigen.x || 0) + (nodoOrigen.tipoNodo === 'ACTIVIDAD' ? 60 : 30)"
                  [attr.y1]="(nodoOrigen.y || 0) + (nodoOrigen.tipoNodo === 'ACTIVIDAD' ? 40 : 30)"
                  [attr.x2]="punteroActual.x"
                  [attr.y2]="punteroActual.y"
                  stroke="#999" stroke-width="2" stroke-dasharray="5,5" />
          }
        </svg>

        @for (act of actividades(); track act.id) {
          <div class="node actividad"
               cdkDrag
               [cdkDragFreeDragPosition]="act.initialPoint"
               (cdkDragMoved)="onDragMoved($event, act)"
               (cdkDragEnded)="onDragEnded($event, act, 'ACTIVIDAD')"
               (mouseup)="finalizarArco(act, TipoNodo.ACTIVIDAD); $event.stopPropagation()"
               (dblclick)="editarActividad(act)">

            <div class="content">
              <strong>{{ act.nombre }}</strong>
              @if (act.rolResponsableNombre) {
                <small>{{ act.rolResponsableNombre }}</small>
              }
            </div>

            <div class="connector" (mousedown)="iniciarArco($event, act, TipoNodo.ACTIVIDAD)">+</div>
          </div>
        }

        @for (gw of gateways(); track gw.id) {
          <div class="node gateway"
               cdkDrag
               [cdkDragFreeDragPosition]="gw.initialPoint"
               (cdkDragMoved)="onDragMoved($event, gw)"
               (cdkDragEnded)="onDragEnded($event, gw, 'GATEWAY')"
               (mouseup)="finalizarArco(gw, TipoNodo.GATEWAY); $event.stopPropagation()"
               (dblclick)="editarGateway(gw)">

            <div class="rhombus">
              <span>?</span>
            </div>
            <small class="label">{{ gw.nombre }}</small>

            <div class="connector" (mousedown)="iniciarArco($event, gw, TipoNodo.GATEWAY)">+</div>
          </div>
        }

      </div>
    </div>

    @if (modoEdicion()) {
      <div class="modal-overlay">
        <div class="form-panel">
          <div class="form-header">
            <h2>{{ elementoEditando() ? 'Editar' : 'Nuevo' }} {{ modoEdicion() }}</h2>
            <button class="btn-close" (click)="cancelarEdicion()">×</button>
          </div>

          @if (modoEdicion() === 'actividad') {
            <form [formGroup]="actividadForm" (ngSubmit)="guardarActividad()">
              <div class="form-group">
                <label>Nombre *</label>
                <input type="text" formControlName="nombre" />
              </div>
              <div class="form-group">
                <label>Descripción</label>
                <textarea formControlName="descripcion" rows="3"></textarea>
              </div>
              <div class="form-group">
                <label>Tipo</label>
                <select formControlName="tipo">
                  <option [value]="TipoActividad.MANUAL">Manual</option>
                  <option [value]="TipoActividad.USUARIO">Usuario</option>
                  <option [value]="TipoActividad.AUTOMATICA">Automática</option>
                </select>
              </div>
              <div class="form-group">
                <label>Rol Responsable</label>
                <select formControlName="rolResponsableId">
                  <option [value]="null">Sin asignar</option>
                  @for (rol of rolesDisponibles(); track rol.id) {
                    <option [value]="rol.id">{{ rol.nombre }}</option>
                  }
                </select>
              </div>
              <div class="form-actions">
                @if (elementoEditando()) {
                  <button type="button" class="btn btn-danger" (click)="eliminarActividad(elementoEditando())">Eliminar</button>
                }
                <button type="submit" class="btn btn-primary">Guardar</button>
              </div>
            </form>
          }

          @if (modoEdicion() === 'gateway') {
            <form [formGroup]="gatewayForm" (ngSubmit)="guardarGateway()">
              <div class="form-group">
                <label>Nombre *</label>
                <input type="text" formControlName="nombre" />
              </div>
              <div class="form-group">
                <label>Tipo</label>
                <select formControlName="tipo">
                  <option [value]="TipoGateway.EXCLUSIVO">Exclusivo (XOR)</option>
                  <option [value]="TipoGateway.INCLUSIVO">Inclusivo (OR)</option>
                  <option [value]="TipoGateway.PARALELO">Paralelo (AND)</option>
                </select>
              </div>
              <div class="form-actions">
                @if (elementoEditando()) {
                  <button type="button" class="btn btn-danger" (click)="eliminarGateway(elementoEditando())">Eliminar</button>
                }
                <button type="submit" class="btn btn-primary">Guardar</button>
              </div>
            </form>
          }
        </div>
      </div>
    }
  }
</div>
